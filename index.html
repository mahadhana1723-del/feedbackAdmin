<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RU DEPOT Feedback Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .dashboard-card { background: linear-gradient(135deg, #1e3a8a 0%, #172554 100%); color: white; }
    </style>
</head>
<body class="pb-20">

    <div class="dashboard-card shadow-2xl border-b-4 border-yellow-500 pb-8 pt-6 px-4">
        <div class="max-w-6xl mx-auto">
            
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold tracking-wide flex items-center">
                    <i class="fa-solid fa-chart-line text-yellow-400 mr-3"></i> 
                    LIVE ANALYTICS DASHBOARD
                </h1>
                <div class="text-right">
                    <span class="text-xs text-blue-300 uppercase tracking-widest block">Total Feedbacks</span>
                    <span class="text-3xl font-bold text-white" id="totalCount">0</span>
                </div>
            </div>

            <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                <h3 class="text-xs font-bold text-blue-200 uppercase tracking-widest mb-4 border-b border-white/10 pb-2">
                    Question-wise Performance (Global Average)
                </h3>
                
                <div id="averagesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4 text-sm">
                    <div class="col-span-full text-center text-blue-200 py-4">Loading stats...</div>
                </div>

                <div class="mt-6 pt-4 border-t border-white/20 flex items-center justify-between">
                    <div>
                        <p class="text-yellow-400 font-bold uppercase tracking-widest text-xs">Overall Performance (Last 6 Months)</p>
                        <p class="text-blue-200 text-xs mt-1">Average rating from all staff for Q9</p>
                    </div>
                    <div class="flex items-center gap-3 bg-white/10 px-4 py-2 rounded-lg border border-yellow-500/50">
                        <span class="text-4xl font-bold text-white" id="globalQ9">0.0</span>
                        <div class="text-yellow-400 text-sm">
                            <i class="fa-solid fa-star"></i>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="max-w-5xl mx-auto px-4 mt-8">
        <h3 class="text-gray-400 font-bold uppercase text-xs tracking-widest mb-4 ml-1">Recent Submissions (Person's Avg Rating)</h3>
        
        <div id="loading" class="text-center py-10">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-600 mb-2"></i>
            <p class="text-gray-500 text-sm">Syncing...</p>
        </div>

        <div id="feedbackList" class="flex flex-col gap-4 hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpEMtX1eP7YwZDH0qLBRGci6VkhBgcJVo",
            authDomain: "feedback-4ace7.firebaseapp.com",
            projectId: "feedback-4ace7",
            storageBucket: "feedback-4ace7.firebasestorage.app",
            messagingSenderId: "331705524032",
            appId: "1:331705524032:web:7e8d046e71984f74a6e4a5",
            measurementId: "G-0WL2N0YFQ1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const questionLabels = {
            q1: "1. Leave Handling",
            q2: "2. CCC Behavior",
            q3: "3. Complaint Response",
            q4: "4. Train Planning",
            q5: "5. Phone Response",
            q6: "6. CC Booking Pattern",
            q7: "7. TPC Staff",
            q8: "8. CMS Staff"
        };

        const q = query(collection(db, "feedbacks"), orderBy("date", "desc"));

        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('feedbackList');
            const avgGrid = document.getElementById('averagesGrid');
            const globalQ9Display = document.getElementById('globalQ9');
            const totalCountDisplay = document.getElementById('totalCount');
            const loading = document.getElementById('loading');

            loading.classList.add('hidden');
            list.classList.remove('hidden');
            
            list.innerHTML = ""; 
            avgGrid.innerHTML = "";

            if(snapshot.empty) {
                list.innerHTML = `<div class="text-center py-10 text-gray-400">No feedback yet.</div>`;
                return;
            }

            // --- STATISTICS VARS ---
            let stats = {
                q1: { sum:0, count:0 }, q2: { sum:0, count:0 }, q3: { sum:0, count:0 },
                q4: { sum:0, count:0 }, q5: { sum:0, count:0 }, q6: { sum:0, count:0 },
                q7: { sum:0, count:0 }, q8: { sum:0, count:0 }, q9: { sum:0, count:0 }
            };

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;

                // 1. Accumulate Stats for Dashboard
                for(let i=1; i<=9; i++) {
                    if(data[`q${i}`]) {
                        stats[`q${i}`].sum += data[`q${i}`];
                        stats[`q${i}`].count++;
                    }
                }

                // 2. CALCULATE PERSON'S AVERAGE (Q1 to Q9)
                // ఈ వ్యక్తి ఇచ్చిన అన్ని రేటింగ్స్ (Q1-Q9) కలిపి సగటు (Average) తీస్తున్నాం.
                let personSum = 0;
                let personCount = 0;
                for(let i=1; i<=9; i++) {
                    if(data[`q${i}`]) {
                        personSum += data[`q${i}`];
                        personCount++;
                    }
                }
                const personAvg = personCount > 0 ? (personSum / personCount).toFixed(1) : "0.0";

                // Color Logic based on Person's Average
                let scoreColor = "text-blue-600 bg-blue-50 border-blue-200";
                if(personAvg >= 4) scoreColor = "text-green-600 bg-green-50 border-green-200";
                if(personAvg <= 2.5) scoreColor = "text-red-600 bg-red-50 border-red-200";

                let dateStr = data.date ? new Date(data.date.seconds * 1000).toLocaleString('en-IN', { 
                        month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' 
                    }) : "Just now";

                const card = `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition flex flex-col sm:flex-row gap-4">
                        
                        <div class="w-full sm:w-28 flex flex-col items-center justify-center border-b sm:border-b-0 sm:border-r border-gray-100 pb-4 sm:pb-0">
                            <span class="text-[0.6rem] text-gray-400 uppercase font-bold mb-1">Total Avg</span>
                            <div class="w-14 h-14 rounded-full border-4 ${scoreColor} flex items-center justify-center bg-white shadow-sm">
                                <span class="text-xl font-bold ${scoreColor.split(' ')[0]}">${personAvg}</span>
                            </div>
                            <span class="text-[0.6rem] text-gray-400 mt-2 font-mono">ID: ${id.slice(-4)}</span>
                        </div>

                        <div class="flex-1 space-y-3">
                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold text-gray-500"><i class="fa-regular fa-clock mr-1"></i> ${dateStr}</span>
                                <button onclick="window.deleteFeedback('${id}')" class="text-gray-300 hover:text-red-500 text-xs uppercase font-bold transition" title="Delete Feedback">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 relative">
                                    <div class="absolute -top-2 left-2 bg-blue-100 text-blue-600 text-[0.6rem] font-bold px-2 rounded">LR Suggestion</div>
                                    <p class="text-xs text-gray-700 italic mt-1 leading-relaxed">"${data.q10 || 'Nil'}"</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 relative">
                                    <div class="absolute -top-2 left-2 bg-purple-100 text-purple-600 text-[0.6rem] font-bold px-2 rounded">General</div>
                                    <p class="text-xs text-gray-700 italic mt-1 leading-relaxed">"${data.q11 || 'Nil'}"</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });

            // --- RENDER DASHBOARD AVERAGES ---
            totalCountDisplay.innerText = snapshot.size;

            for(let i=1; i<=8; i++) {
                let avg = stats[`q${i}`].count > 0 ? (stats[`q${i}`].sum / stats[`q${i}`].count).toFixed(1) : "0.0";
                
                let percent = (avg / 5) * 100;
                let colorClass = avg >= 4 ? "bg-green-400" : (avg <= 2.5 ? "bg-red-400" : "bg-yellow-400");

                avgGrid.innerHTML += `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex-1 mr-4">
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-300 text-xs">${questionLabels[`q${i}`]}</span>
                                <span class="font-bold text-white text-xs">${avg}</span>
                            </div>
                            <div class="w-full bg-blue-900 rounded-full h-1.5">
                                <div class="${colorClass} h-1.5 rounded-full" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Global Q9 Update
            let globalAvg = stats.q9.count > 0 ? (stats.q9.sum / stats.q9.count).toFixed(1) : "0.0";
            globalQ9Display.innerText = globalAvg;

        });

        window.deleteFeedback = async (id) => {
            if(confirm("Delete this feedback permanently?")) {
                try { await deleteDoc(doc(db, "feedbacks", id)); } 
                catch(e) { alert("Error: " + e.message); }
            }
        }
    </script>
</body>
</html>